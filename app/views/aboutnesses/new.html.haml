%h1= t('aboutnesses.new.add_subject_heading')

.work-context
  %h3.work-context-title
    üìö
    = @embodiment.expression&.title || t('aboutnesses.new.untitled_work')
  - if @embodiment.expression&.work
    %p.work-context-info
      %strong= t('aboutnesses.new.work_label', default: 'Work:')
      = @embodiment.expression.work.title
    - if @embodiment.expression.work.creators.any?
      %p.work-context-info
        %strong= t('manifestations.show.authors_label', default: 'Authors:')
        = @embodiment.expression.work.creators.map(&:name).join(', ')
  - if @embodiment.manifestation&.toc&.authors&.any?
    %p.work-context-info
      %strong= t('manifestations.show.authors_label', default: 'Authors:')
      = "(#{t('aboutnesses.new.from_toc', default: 'from TOC')})"
      = @embodiment.manifestation.toc.authors.map(&:name).join(', ')
  - if @embodiment.manifestation&.toc
    %p.work-context-info
      %strong= t('aboutnesses.new.publication_label', default: 'From publication:')
      = link_to @embodiment.manifestation.toc.title, toc_path(@embodiment.manifestation.toc)
  - existing_subjects = @embodiment.aboutnesses
  - if existing_subjects.any?
    %p.work-context-info
      %strong= t('aboutnesses.new.existing_subjects', default: 'Existing subjects:')
    .subject-tags
      - existing_subjects.each do |aboutness|
        %span.subject-tag
          = aboutness.subject_heading_label

%p= t('aboutnesses.new.instructions', title: @embodiment.expression&.title || 'this text')

.row
  .col-xs-12
    .form-group
      = label_tag :source, 'Cataloging Source:'
      = select_tag :source, options_for_select([['Library of Congress Subject Headings', 'LCSH'], ['Wikidata', 'Wikidata']], 'LCSH'), class: 'form-control', id: 'source_select'

    .form-group
      = label_tag :query, 'Search:'
      .input-group
        = text_field_tag :query, '', class: 'form-control', placeholder: 'Enter search term...', id: 'search_query'
        %span.input-group-btn
          = button_tag 'Search', type: 'button', class: 'btn btn-primary', id: 'search_button'

    #search_results
      -# Search results will be loaded here via AJAX

    = form_for [@embodiment, @aboutness], html: { id: 'aboutness_form', style: 'display:none;' } do |f|
      = f.hidden_field :subject_heading_uri, id: 'selected_uri'
      = f.hidden_field :source_name, id: 'selected_source'
      = f.hidden_field :subject_heading_label, id: 'selected_label'
      = f.submit 'Add Subject Heading', class: 'btn btn-success'

    %p
      = link_to 'Back', embodiment_aboutnesses_path(@embodiment), class: 'btn btn-default'

:javascript
  $(document).ready(function() {
    var currentPage = 1;
    var currentQuery = '';
    var currentSource = '';

    function performSearch(page) {
      var source = $('#source_select').val();
      var query = $('#search_query').val();

      if (!query) {
        alert('Please enter a search term');
        return;
      }

      currentQuery = query;
      currentSource = source;
      currentPage = page;

      $.ajax({
        url: '#{search_embodiment_aboutnesses_path(@embodiment)}',
        type: 'POST',
        data: { source: source, query: query, page: page },
        dataType: 'json',
        beforeSend: function() {
          $('#search_results').html('<div class="loading-spinner"><div class="spinner"></div><span class="loading-text">Searching...</span></div>');
        },
        success: function(data) {
          var results = data.results || [];
          var hasMore = data.has_more || false;
          var currentPage = data.page || 1;

          if (results.length === 0) {
            $('#search_results').html('<p class="text-muted">No results found.</p>');
          } else {
            var html = '<h3>Search Results <span class="badge">' + results.length + '</span></h3><div class="list-group">';
            $.each(results, function(index, result) {
              html += '<a href="#" class="list-group-item result-item" data-uri="' + result.uri + '" data-label="' + result.label + '" data-source="' + source + '" style="margin-bottom: 0.5rem; border-radius: 8px; transition: all 0.2s;">';
              html += '<h4 class="list-group-item-heading" style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">' + result.label + '</h4>';

              // Show description (Wikidata)
              if (result.description) {
                html += '<p class="list-group-item-text" style="color: #4a5568; margin-bottom: 0.5rem;"><em>' + result.description + '</em></p>';
              }

              // Show instance_of (Wikidata)
              if (result.instance_of && result.instance_of.length > 0) {
                html += '<p class="list-group-item-text" style="margin-bottom: 0.25rem;"><small style="color: #718096;"><strong>Instance of:</strong> ' + result.instance_of.join(', ') + '</small></p>';
              }

              // Show entity ID (Wikidata)
              if (result.entity_id) {
                html += '<p class="list-group-item-text" style="margin-bottom: 0.25rem;"><small style="color: #718096;"><strong>Entity ID:</strong> ' + result.entity_id + '</small></p>';
              }

              // Show LC ID (LCSH)
              if (result.lc_id) {
                html += '<p class="list-group-item-text" style="margin-bottom: 0.25rem;"><small style="color: #718096;"><strong>LC ID:</strong> ' + result.lc_id + '</small></p>';
              }

              // Show broader terms (LCSH)
              if (result.broader && result.broader.length > 0) {
                html += '<p class="list-group-item-text" style="margin-bottom: 0.25rem;"><small style="color: #718096;"><strong>Broader:</strong> ' + result.broader.join(', ') + '</small></p>';
              }

              // Show alternate labels (LCSH)
              if (result.alt_labels && result.alt_labels.length > 0) {
                html += '<p class="list-group-item-text" style="margin-bottom: 0.25rem;"><small style="color: #718096;"><strong>Alt labels:</strong> ' + result.alt_labels.join(', ') + '</small></p>';
              }

              html += '<p class="list-group-item-text" style="margin-top: 0.5rem;"><small><a href="' + result.uri + '" target="_blank" style="color: #667eea;">' + result.uri + ' ‚Üí</a></small></p>';
              html += '</a>';
            });
            html += '</div>';

            // Add pagination controls
            if (currentPage > 1 || hasMore) {
              html += '<div class="pagination-controls" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">';

              // Previous button
              if (currentPage > 1) {
                html += '<button class="btn btn-default pagination-btn" data-page="' + (currentPage - 1) + '">‚Üê Previous</button>';
              } else {
                html += '<button class="btn btn-default" disabled>‚Üê Previous</button>';
              }

              // Page indicator
              html += '<span class="text-muted">Page ' + currentPage + '</span>';

              // Next button
              if (hasMore) {
                html += '<button class="btn btn-default pagination-btn" data-page="' + (currentPage + 1) + '">Next ‚Üí</button>';
              } else {
                html += '<button class="btn btn-default" disabled>Next ‚Üí</button>';
              }

              html += '</div>';
            }

            $('#search_results').html(html);
          }
        },
        error: function() {
          $('#search_results').html('<p class="text-danger">Error performing search. Please try again.</p>');
        }
      });
    }

    $('#search_button').click(function() {
      performSearch(1);
    });

    $(document).on('click', '.pagination-btn', function(e) {
      e.preventDefault();
      var page = $(this).data('page');
      performSearch(page);
    });

    $(document).on('click', '.result-item', function(e) {
      e.preventDefault();
      var uri = $(this).data('uri');
      var label = $(this).data('label');
      var source = $(this).data('source');

      $('#selected_uri').val(uri);
      $('#selected_label').val(label);
      $('#selected_source').val(source);

      $('.result-item').removeClass('active');
      $(this).addClass('active');

      $('#aboutness_form').show();
    });

    $('#search_query').keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        $('#search_button').click();
      }
    });
  });

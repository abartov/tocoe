%h1= t('aboutnesses.new.add_subject_heading')

.work-context{style: 'background: #f7fafc; border-left: 4px solid #667eea; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 4px;'}
  %h3{style: 'font-size: 1.2rem; margin-bottom: 0.5rem; color: #2d3748;'}
    ðŸ“š
    = @embodiment.expression&.title || t('aboutnesses.new.untitled_work')
  - if @embodiment.expression&.work
    %p{style: 'color: #4a5568; margin-bottom: 0.5rem;'}
      %strong= t('aboutnesses.new.work_label', default: 'Work:')
      = @embodiment.expression.work.title
  - existing_subjects = @embodiment.aboutnesses
  - if existing_subjects.any?
    %p{style: 'color: #4a5568; margin-bottom: 0.25rem;'}
      %strong= t('aboutnesses.new.existing_subjects', default: 'Existing subjects:')
    .subject-tags{style: 'display: flex; flex-wrap: wrap; gap: 0.5rem;'}
      - existing_subjects.each do |aboutness|
        %span.label.label-primary{style: 'font-size: 1rem; padding: 0.4rem 0.8rem; border-radius: 12px; background: #667eea;'}
          = aboutness.subject_heading_label

%p= t('aboutnesses.new.instructions', title: @embodiment.expression&.title || 'this text')

.row
  .col-xs-12
    .form-group
      = label_tag :source, 'Cataloging Source:'
      = select_tag :source, options_for_select([['Library of Congress Subject Headings', 'LCSH'], ['Wikidata', 'Wikidata']], 'LCSH'), class: 'form-control', id: 'source_select'

    .form-group
      = label_tag :query, 'Search:'
      .input-group
        = text_field_tag :query, '', class: 'form-control', placeholder: 'Enter search term...', id: 'search_query'
        %span.input-group-btn
          = button_tag 'Search', type: 'button', class: 'btn btn-primary', id: 'search_button'

    #search_results
      -# Search results will be loaded here via AJAX

    = form_for [@embodiment, @aboutness], html: { id: 'aboutness_form', style: 'display:none;' } do |f|
      = f.hidden_field :subject_heading_uri, id: 'selected_uri'
      = f.hidden_field :source_name, id: 'selected_source'
      = f.hidden_field :subject_heading_label, id: 'selected_label'
      = f.submit 'Add Subject Heading', class: 'btn btn-success'

    %p
      = link_to 'Back', embodiment_aboutnesses_path(@embodiment), class: 'btn btn-default'

:javascript
  $(document).ready(function() {
    $('#search_button').click(function() {
      var source = $('#source_select').val();
      var query = $('#search_query').val();

      if (!query) {
        alert('Please enter a search term');
        return;
      }

      $.ajax({
        url: '#{search_embodiment_aboutnesses_path(@embodiment)}',
        type: 'POST',
        data: { source: source, query: query },
        dataType: 'json',
        beforeSend: function() {
          $('#search_results').html('<div class="loading-spinner"><div class="spinner"></div><span class="loading-text">Searching...</span></div>');
        },
        success: function(data) {
          if (data.length === 0) {
            $('#search_results').html('<p class="text-muted">No results found.</p>');
          } else {
            var html = '<h3>Search Results</h3><div class="list-group">';
            $.each(data, function(index, result) {
              html += '<a href="#" class="list-group-item result-item" data-uri="' + result.uri + '" data-label="' + result.label + '" data-source="' + source + '">';
              html += '<h4 class="list-group-item-heading">' + result.label + '</h4>';
              if (result.instance_of && result.instance_of.length > 0) {
                html += '<p class="list-group-item-text"><small>Instance of: ' + result.instance_of.join(', ') + '</small></p>';
              }
              html += '<p class="list-group-item-text"><small><a href="' + result.uri + '" target="_blank">' + result.uri + '</a></small></p>';
              html += '</a>';
            });
            html += '</div>';
            $('#search_results').html(html);
          }
        },
        error: function() {
          $('#search_results').html('<p class="text-danger">Error performing search. Please try again.</p>');
        }
      });
    });

    $(document).on('click', '.result-item', function(e) {
      e.preventDefault();
      var uri = $(this).data('uri');
      var label = $(this).data('label');
      var source = $(this).data('source');

      $('#selected_uri').val(uri);
      $('#selected_label').val(label);
      $('#selected_source').val(source);

      $('.result-item').removeClass('active');
      $(this).addClass('active');

      $('#aboutness_form').show();
    });

    $('#search_query').keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        $('#search_button').click();
      }
    });
  });

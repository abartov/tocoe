= render 'shared/workflow_stepper', toc: @toc if @toc.persisted?

.toc-form-container
  = form_for @toc do |f|
    - if @toc.errors.any?
      #error_explanation.alert.alert-danger
        %h2= t('tocs.form.error_message', count: @toc.errors.count)
        %ul
          - @toc.errors.full_messages.each do |msg|
            %li= msg

    = hidden_field_tag 'toc[book_data]', @toc.book_data.to_json if @toc.book_data.present?

    %ul.nav.nav-tabs{role: 'tablist'}
      %li.active
        %a{href: '#basic-info', 'data-toggle': 'tab'}
          = t('tocs.form.tabs.basic_info')
      - if @toc.persisted?
        %li
          %a{href: '#toc-body', 'data-toggle': 'tab'}
            = t('tocs.form.tabs.toc_body')
        %li
          %a{href: '#subjects', 'data-toggle': 'tab'}
            = t('tocs.form.tabs.subjects')
            - if @toc.imported_subjects.present?
              %span.badge= @toc.imported_subjects.lines.count
        %li
          %a{href: '#ocr', 'data-toggle': 'tab'}
            = t('tocs.form.tabs.ocr')

    .tab-content
      .tab-pane.active{id: 'basic-info'}
        = render 'basic_info_tab', f: f
      - if @toc.persisted?
        .tab-pane{id: 'toc-body'}
          = render 'toc_body_tab', f: f
        .tab-pane{id: 'subjects'}
          = render 'subjects_tab', f: f
        .tab-pane{id: 'ocr'}
          = render 'ocr_tab', f: f

    .form-actions
      = f.submit t('common.actions.save'), class: 'btn btn-primary btn-lg'
      = link_to t('common.actions.back'), :back, class: 'btn btn-default'

:javascript
  // Auto-match subjects button
  $('#auto_match_subjects').click(function() {
    $('#auto_match_subjects').prop('disabled', true);
    $('#auto_match_working').show();
    $('#auto_match_results').html('');

    $.ajax({
      url: '#{@toc.persisted? ? auto_match_subjects_toc_path(@toc) : ""}',
      type: 'POST',
      dataType: 'script',
      headers: {
        'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
      }
    });
  });

  // Handle accept match button clicks (delegated event handler)
  $(document).on('click', '.accept-match', function() {
    var button = $(this);
    var subject = button.data('subject');
    var uri = button.data('uri');
    var label = button.data('label');
    var embodimentId = '#{@toc.manifestation ? @toc.manifestation.embodiments.find_by(sequence_number: nil)&.id : ""}';

    button.prop('disabled', true);
    button.text('Adding...');

    $.ajax({
      url: '/embodiments/' + embodimentId + '/aboutnesses',
      type: 'POST',
      dataType: 'json',
      data: {
        aboutness: {
          subject_heading_uri: uri,
          subject_heading_label: label,
          source_name: 'LCSH'
        },
        remove_subject: subject
      },
      headers: {
        'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
      },
      success: function(data) {
        // Remove the suggestion item
        button.closest('.suggestion-item').fadeOut(function() {
          $(this).remove();
        });

        // Reload page to show updated aboutnesses and imported_subjects
        setTimeout(function() {
          location.reload();
        }, 500);
      },
      error: function(xhr, status, error) {
        button.prop('disabled', false);
        button.text('#{I18n.t('tocs.form.subjects_section.accept_match')}');
        alert('Error adding subject heading: ' + error);
      }
    });
  });

  // Magic trim button handler
  $('#magic_trim').click(function() {
    var textarea = $('#toc_area');
    var text = textarea.val();
    var lines = text.split('\n');
    var processedLines = [];

    lines.forEach(function(line) {
      // Skip empty lines
      if (line.trim() === '') {
        processedLines.push('');
        return;
      }

      // Preserve section headings (lines ending with /)
      if (line.trim().endsWith('/')) {
        processedLines.push(line.trim());
        return;
      }

      // Try to extract page number from the end of the line
      // Look for digits potentially followed by whitespace at the end
      var pageNumberMatch = line.match(/^(.+?)[\s\.]+(\d+)\s*$/);

      if (pageNumberMatch) {
        // Found a page number
        var title = pageNumberMatch[1].trim();
        var pageNumber = pageNumberMatch[2];

        // Clean up the title: remove trailing periods and extra whitespace
        title = title.replace(/\.+\s*$/, '').trim();

        processedLines.push(title + ' || ' + pageNumber);
      } else {
        // No page number found, just clean up the line
        var cleanTitle = line.trim().replace(/\.+\s*$/, '').trim();
        processedLines.push(cleanTitle);
      }
    });

    // Update the textarea with processed text
    textarea.val(processedLines.join('\n'));
  });

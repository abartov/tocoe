.ocr-section
  - if @toc.source == 'openlibrary' && !@toc.empty?
    - if help_enabled?
      .contextual-help-panel
        .help-header
          %h4
            %span.glyphicon.glyphicon-info-sign.help-icon
            = t('help.contextual.ocr.title')
          %button.btn.btn-sm.btn-default{type: 'button', 'data-toggle' => 'collapse', 'data-target' => '#ocrContextHelp'}
            = t('help.contextual.common.show_hide')

        .collapse#ocrContextHelp
          .help-content
            .row
              .col-md-6
                %h5= t('help.contextual.ocr.when_to_use_title')
                %p= t('help.contextual.ocr.when_to_use_desc')

                %h5= t('help.contextual.ocr.quality_expectations_title')
                %ul
                  %li
                    %strong= t('help.contextual.ocr.quality_good')
                    = t('help.contextual.ocr.quality_good_desc')
                  %li
                    %strong= t('help.contextual.ocr.quality_fair')
                    = t('help.contextual.ocr.quality_fair_desc')
                  %li
                    %strong= t('help.contextual.ocr.quality_poor')
                    = t('help.contextual.ocr.quality_poor_desc')

              .col-md-6
                .help-example.help-example-interactive
                  %h5= t('help.contextual.ocr.example_title')

                  .ocr-example-before
                    %p
                      %strong= t('help.contextual.ocr.example_raw_ocr')
                    %pre.code-example= t('help.contextual.ocr.example_raw_text')

                  .ocr-example-after{style: 'margin-top: 1rem;'}
                    %p
                      %strong= t('help.contextual.ocr.example_after_magic_trim')
                    %pre.code-example= t('help.contextual.ocr.example_trimmed_text')

            .help-callout.help-callout-warning
              %h5= t('help.contextual.ocr.tip_title')
              %p= t('help.contextual.ocr.tip_manual_better')

    -# Simplified OCR: show scans directly with Extract Text button on each
    - if @toc.toc_page_urls.present?
      .panel.panel-default
        .panel-heading
          %h4= t('tocs.form.ocr_section.title')
        .panel-body
          = hidden_field_tag :toc_id, @toc.id

          -# Display each scan with its own Extract Text button
          .toc-scans
            - @toc.toc_page_urls.split("\n").map(&:strip).reject(&:blank?).each_with_index do |url, index|
              .scan-item{style: 'margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #ddd;', data: {url: url, index: index}}
                .row
                  .col-md-6
                    .scan-image-container{style: 'text-align: center;'}
                      = image_tag "#{url}?scale=8", alt: t('tocs.show.page_number', number: index + 1), class: 'img-thumbnail scan-image', style: 'max-width: 100%; height: auto; cursor: pointer;', data: {url: url, index: index}
                      %p.text-center.small{style: 'margin-top: 5px;'}
                        = t('tocs.show.page_number', number: index + 1)
                  .col-md-6
                    .scan-controls
                      %button.btn.btn-primary.extract-text-btn{type: 'button', data: {url: url, index: index}}
                        %span.glyphicon.glyphicon-eye-open
                        = t('tocs.form.ocr_section.extract_text_button')
                      .loading-spinner{style: 'display:none; margin-top: 10px;'}
                        .spinner
                        %span.loading-text= t('tocs.form.ocr_section.processing')

                    .ocr-result-container{style: 'margin-top: 15px; display: none;'}
                      .ocr-result{style: 'max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap;'}
                      .ocr-actions{style: 'margin-top: 10px;'}
                        %button.btn.btn-success.paste-result-btn{type: 'button', data: {index: index}}
                          %span.glyphicon.glyphicon-paste
                          = t('tocs.form.ocr_section.paste_button')

    -# Modal for zoomed scan view
    - if @toc.toc_page_urls.present?
      .modal.fade#scanZoomModal{tabindex: '-1', role: 'dialog', 'aria-labelledby' => 'scanZoomModalLabel', 'aria-hidden' => 'true'}
        .modal-dialog.modal-lg{role: 'document', style: 'max-width: 90%;'}
          .modal-content
            .modal-header
              %h5.modal-title#scanZoomModalLabel
                = t('tocs.form.ocr_section.scan_modal_title')
              %button.close{type: 'button', 'data-dismiss' => 'modal', 'aria-label' => 'Close'}
                %span{'aria-hidden' => 'true'} &times;
            .modal-body{style: 'text-align: center;'}
              %img#scanZoomImage{src: '', alt: '', style: 'max-width: 100%; height: auto;'}

    :javascript
      // Handle click on scan images to open zoomed modal
      $('.scan-image').click(function() {
        var imageUrl = $(this).data('url');
        var pageIndex = $(this).data('index');
        var pageNumber = pageIndex + 1;
        var modalTitle = '#{I18n.t('tocs.show.page_number', number: '__PAGE__').gsub('__PAGE__', '\' + pageNumber + \'')}';

        $('#scanZoomModalLabel').text(modalTitle);
        $('#scanZoomImage').attr('src', imageUrl);
        $('#scanZoomImage').attr('alt', modalTitle);
        $('#scanZoomModal').modal('show');
      });

      // Handle Extract Text button clicks
      $('.extract-text-btn').click(function() {
        var $btn = $(this);
        var $scanItem = $btn.closest('.scan-item');
        var $spinner = $scanItem.find('.loading-spinner');
        var $resultContainer = $scanItem.find('.ocr-result-container');
        var $result = $scanItem.find('.ocr-result');
        var url = $btn.data('url');

        // Disable button and show loading
        $btn.prop('disabled', true);
        $spinner.show();
        $resultContainer.hide();
        $result.html('');

        // Make AJAX POST request for single image
        $.ajax({
          url: '#{tocs_do_ocr_path}',
          type: 'POST',
          dataType: 'json',
          data: {
            toc_id: $('#toc_id').val(),
            ocr_images: url
          },
          headers: {
            'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
          },
          success: function(response) {
            $btn.prop('disabled', false);
            $spinner.hide();
            $result.text(response.results);
            $resultContainer.show();
          },
          error: function(xhr, status, error) {
            $btn.prop('disabled', false);
            $spinner.hide();
            $result.html('<span style="color: red;">Error: ' + error + '</span>');
            $resultContainer.show();
          }
        });
      });

      // Handle paste button clicks
      $('.paste-result-btn').click(function() {
        var $btn = $(this);
        var $scanItem = $btn.closest('.scan-item');
        var $result = $scanItem.find('.ocr-result');
        var currentText = $('#toc_area').val();
        var ocrText = $result.text();

        // Append to existing text or replace if empty
        if (currentText.trim() === '') {
          $('#toc_area').val(ocrText);
        } else {
          $('#toc_area').val(currentText + '\n\n' + ocrText);
        }

        // Switch to TOC Body tab after pasting
        $('a[href="#toc-body"]').tab('show');
      });

  - elsif @is_gutenberg && @fulltext_url
    .panel.panel-default
      .panel-heading
        %h4= t('tocs.form.gutenberg_section.fulltext_available_title')
      .panel-body
        %p.text-muted= t('tocs.form.gutenberg_section.fulltext_help')
        -# Use server-side proxy to avoid mixed content issues from Gutenberg's HTTP redirects
        %iframe{ src: gutenberg_proxy_tocs_path(url: @fulltext_url), style: 'width: 100%; height: 600px; border: 1px solid #ddd;' }

  - else
    .panel.panel-info
      .panel-heading
        %h4= t('tocs.form.ocr_section.no_pages_marked_title')
      .panel-body
        %p= t('tocs.form.ocr_section.browse_scans_help')
        = link_to t('tocs.form.ocr_section.browse_scans_button'), browse_scans_toc_path(@toc), class: 'btn btn-primary btn-lg'

.toc-body-section
  -# Toggle button for reference material
  - if (@toc.source == 'openlibrary' && @toc.toc_page_urls.present?) || (@is_gutenberg && @fulltext_url.present?)
    .reference-toggle-section{style: 'margin-bottom: 15px;'}
      %button.btn.btn-info#toggleReference{type: 'button'}
        %span#toggleIcon.glyphicon.glyphicon-eye-open
        %span#toggleText Show Reference Material
      %span.help-block{style: 'display: inline-block; margin-left: 10px;'}
        View scans or fulltext while transcribing

  .toc-body-layout
    -# Reference material panel (hidden by default)
    - if (@toc.source == 'openlibrary' && @toc.toc_page_urls.present?) || (@is_gutenberg && @fulltext_url.present?)
      .reference-panel#referencePanel{style: 'display: none;'}
        - if @toc.source == 'openlibrary' && @toc.toc_page_urls.present?
          .reference-scans
            .panel.panel-default
              .panel-heading
                %h4{style: 'margin: 0;'}= t('tocs.form.ocr_section.scans_title')
              .panel-body
                .toc-scans-controls{style: 'margin-bottom: 10px; padding: 10px; background-color: #e9ecef; border: 1px solid #ddd; border-radius: 3px;'}
                  %span{style: 'margin-right: 10px; font-weight: bold;'}
                    = t('tocs.form.ocr_section.zoom_label')
                  %button.btn.btn-sm.btn-default.zoomInBtn{type: 'button', title: t('tocs.form.ocr_section.zoom_in_title')}
                    %span{style: 'font-weight: bold; font-size: 16px;'} +
                  %button.btn.btn-sm.btn-default.zoomOutBtn{type: 'button', title: t('tocs.form.ocr_section.zoom_out_title'), style: 'margin-left: 5px;'}
                    %span{style: 'font-weight: bold; font-size: 16px;'} âˆ’
                  %button.btn.btn-sm.btn-default.zoomDefaultBtn{type: 'button', title: t('tocs.form.ocr_section.zoom_default_title'), style: 'margin-left: 5px;'}
                    %span{style: 'font-weight: bold;'} def
                .toc-scans-thumbnails{style: 'max-height: 600px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f8f9fa;'}
                  - @toc.toc_page_urls.split("\n").map(&:strip).reject(&:blank?).each_with_index do |url, index|
                    .toc-scan-thumb{style: 'display: inline-block; margin: 5px; cursor: pointer; vertical-align: top; width: 300px;', 'data-image-url' => url, 'data-page-number' => index + 1, 'data-default-width' => '300'}
                      .image-loading-container{style: "height: 350px; width: 300px;"}
                        = image_tag "#{url}?scale=8", alt: t('tocs.show.page_number', number: index + 1), class: 'img-thumbnail toc-scan-image image-loader', data: { image_id: "body-#{index}" }, style: 'width: 300px; height: auto;'
                      .text-center.small
                        = t('tocs.show.page_number', number: index + 1)
        - elsif @is_gutenberg && @fulltext_url.present?
          .reference-fulltext
            .panel.panel-default
              .panel-heading
                %h4{style: 'margin: 0;'}= t('tocs.form.gutenberg_section.fulltext_available_title')
              .panel-body
                %p.text-muted= t('tocs.form.gutenberg_section.fulltext_help')
                %iframe{ src: @fulltext_url, style: 'width: 100%; height: 600px; border: 1px solid #ddd;' }

    -# Editing panel
    .editing-panel
      .toc-body-controls
        = button_tag(type: 'button', id: 'magic_trim', class: 'btn btn-primary') do
          %span.glyphicon.glyphicon-scissors
          = t('tocs.form.magic_trim_button')
        = help_tooltip t('tocs.form.magic_trim_tooltip'), placement: 'right'
        %span.help-block= t('tocs.form.magic_trim_help')

      .form-group
        = f.label t('tocs.form.toc_body_label'), class: 'control-label'
        = f.text_area :toc_body, rows: 20, id: 'toc_area', class: 'form-control toc-textarea', placeholder: t('tocs.form.toc_body_placeholder')

  .markdown-help-section
    .help-header
      %h4 ðŸ“– #{t('tocs.form.markdown_help_title')}
      %button.btn.btn-sm.btn-default{type: 'button', 'data-toggle' => 'collapse', 'data-target' => '#markdownHelp'}
        = t('tocs.form.show_hide_help')

    .collapse#markdownHelp
      .markdown-help{style: 'background: #f7fafc; padding: 1rem; border-radius: 6px; border: 2px solid #e2e8f0; font-size: 0.85rem;'}
        %div{style: 'line-height: 1.6;'}
          %p{style: 'margin-bottom: 0.5rem;'}
            %code{style: 'background: #edf2f7; padding: 0.2rem 0.4rem; border-radius: 3px;'}
              = "# Title"
            %span{style: 'color: #4a5568;'}= " - #{t('tocs.form.markdown_help.top_level')}"
          %p{style: 'margin-bottom: 0.5rem;'}
            %code{style: 'background: #edf2f7; padding: 0.2rem 0.4rem; border-radius: 3px;'}
              = "## Title"
            %span{style: 'color: #4a5568;'}= " - #{t('tocs.form.markdown_help.nested')}"
          %p{style: 'margin-bottom: 0.5rem;'}
            %code{style: 'background: #edf2f7; padding: 0.2rem 0.4rem; border-radius: 3px;'}
              = "# Title || Author"
            %span{style: 'color: #4a5568;'}= " - #{t('tocs.form.markdown_help.with_author')}"
          %p{style: 'margin-bottom: 0.5rem;'}
            %code{style: 'background: #edf2f7; padding: 0.2rem 0.4rem; border-radius: 3px;'}
              = "# Title || Author1; Author2"
            %span{style: 'color: #4a5568;'}= " - #{t('tocs.form.markdown_help.multiple_authors')}"
          %p{style: 'margin-bottom: 0;'}
            %code{style: 'background: #edf2f7; padding: 0.2rem 0.4rem; border-radius: 3px;'}
              = "# Section /"
            %span{style: 'color: #4a5568;'}= " - #{t('tocs.form.markdown_help.section_heading')}"
          %hr{style: 'margin: 0.75rem 0; border: 0; border-top: 1px solid #e2e8f0;'}
          %p{style: 'margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;'}
            = "#{t('tocs.form.markdown_help.example')}:"
          %pre{style: 'background: #edf2f7; padding: 0.5rem; border-radius: 3px; font-size: 0.75rem; margin: 0;'}
            = "# Book Title || Author Name\n## Chapter One\n## Chapter Two\n# Part Two /\n## Chapter Three"

-# Modal for zoomed scan view (only for Open Library with scans)
- if @toc.source == 'openlibrary' && @toc.toc_page_urls.present?
  .modal.fade#scanZoomModalBody{tabindex: '-1', role: 'dialog', 'aria-labelledby' => 'scanZoomModalBodyLabel', 'aria-hidden' => 'true'}
    .modal-dialog.modal-lg{role: 'document', style: 'max-width: 90%;'}
      .modal-content
        .modal-header
          %h5.modal-title#scanZoomModalBodyLabel
            = t('tocs.form.ocr_section.scan_modal_title')
          %button.close{type: 'button', 'data-dismiss' => 'modal', 'aria-label' => 'Close'}
            %span{'aria-hidden' => 'true'} &times;
        .modal-body{style: 'text-align: center;'}
          %img#scanZoomImageBody{src: '', alt: '', style: 'max-width: 100%; height: auto;'}

:javascript
  // Toggle reference panel visibility
  $('#toggleReference').click(function() {
    var panel = $('#referencePanel');
    var icon = $('#toggleIcon');
    var text = $('#toggleText');
    var layout = $('.toc-body-layout');

    if (panel.is(':visible')) {
      // Hide panel
      panel.hide();
      layout.removeClass('side-by-side');
      icon.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');
      text.text('Show Reference Material');
    } else {
      // Show panel
      panel.show();
      layout.addClass('side-by-side');
      icon.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');
      text.text('Hide Reference Material');
    }
  });

  // Handle click on scan thumbnails in TOC Body tab to open zoomed modal
  $('.toc-scan-thumb').click(function() {
    var imageUrl = $(this).data('image-url');
    var pageNumber = $(this).data('page-number');
    var modalTitle = '#{I18n.t('tocs.show.page_number', number: '__PAGE__').gsub('__PAGE__', '\' + pageNumber + \'')}';

    $('#scanZoomModalBodyLabel').text(modalTitle);
    $('#scanZoomImageBody').attr('src', imageUrl);
    $('#scanZoomImageBody').attr('alt', modalTitle);
    $('#scanZoomModalBody').modal('show');
  });

  // Zoom controls for TOC scan thumbnails in TOC Body tab
  $('.zoomInBtn').click(function() {
    $('.toc-scan-thumb').each(function() {
      var $thumb = $(this);
      var $img = $thumb.find('.toc-scan-image');
      var currentWidth = $img.width();
      var newWidth = Math.round(currentWidth * 1.2);

      $thumb.css('width', newWidth + 'px');
      $img.css('width', newWidth + 'px');
    });
  });

  $('.zoomOutBtn').click(function() {
    $('.toc-scan-thumb').each(function() {
      var $thumb = $(this);
      var $img = $thumb.find('.toc-scan-image');
      var currentWidth = $img.width();
      var newWidth = Math.round(currentWidth * 0.8);

      // Don't go below 100px
      if (newWidth < 100) newWidth = 100;

      $thumb.css('width', newWidth + 'px');
      $img.css('width', newWidth + 'px');
    });
  });

  $('.zoomDefaultBtn').click(function() {
    $('.toc-scan-thumb').each(function() {
      var $thumb = $(this);
      var $img = $thumb.find('.toc-scan-image');
      var defaultWidth = $thumb.data('default-width');

      $thumb.css('width', defaultWidth + 'px');
      $img.css('width', defaultWidth + 'px');
    });
  });

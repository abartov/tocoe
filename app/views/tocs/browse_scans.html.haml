%h1= t('tocs.browse_scans.title', book_title: @toc.title)

%p
  = t('tocs.browse_scans.viewing_pages')
  = (@current_page - 1) * @page_size + 1
  = t('tocs.browse_scans.to')
  = [@current_page * @page_size, @metadata[:imagecount]].min
  = t('tocs.browse_scans.of')
  = @metadata[:imagecount]

= form_tag mark_pages_toc_path(@toc), method: :post, id: 'mark_pages_form' do
  .row
    .col-md-12
      .alert.alert-info
        %strong= t('tocs.browse_scans.instructions_title')
        = t('tocs.browse_scans.instructions_text')

  .row
    .col-md-12
      .form-check.mb-3
        = check_box_tag 'no_explicit_toc', '1', @toc.no_explicit_toc, class: 'form-check-input', id: 'no_explicit_toc'
        = label_tag 'no_explicit_toc', t('tocs.browse_scans.no_explicit_toc_label'), class: 'form-check-label'
        = help_tooltip t('tocs.browse_scans.no_explicit_toc_tooltip'), placement: 'right'

  .row.scan-grid
    - @pages.each do |page_data|
      .col-md-3.col-sm-4.col-xs-6.scan-page{ data: { page: page_data[:page_number] } }
        .card.mb-3.scan-card{ class: (@marked_pages.include?(page_data[:url]) ? 'selected' : '') }
          = image_tag page_data[:thumb_url], class: 'card-img-top', alt: t('tocs.browse_scans.page_label', number: page_data[:page_number]), data: { full_url: page_data[:url] }
          .card-body
            .form-check
              = check_box_tag "marked_pages[]", page_data[:url], @marked_pages.include?(page_data[:url]), class: 'form-check-input page-checkbox', id: "page_#{page_data[:page_number]}"
              = label_tag "page_#{page_data[:page_number]}", t('tocs.browse_scans.page_label', number: page_data[:page_number]), class: 'form-check-label'
            %a.btn.btn-sm.btn-link.view-full-link{ href: page_data[:url], target: '_blank', onclick: 'event.stopPropagation();' }
              = t('tocs.browse_scans.view_full_size')

  .row
    .col-md-12
      %nav{ aria: { label: 'Page navigation' } }
        %ul.pagination
          - if @current_page > 1
            %li.page-item
              = link_to t('tocs.browse_scans.first'), browse_scans_toc_path(@toc, page: 1), class: 'page-link'
            %li.page-item
              = link_to t('tocs.browse_scans.previous'), browse_scans_toc_path(@toc, page: @current_page - 1), class: 'page-link'
          - else
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.first')
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.previous')

          - ([1, @current_page - 2].max..[[@current_page + 2, @total_pages].min].min).each do |page_num|
            - if page_num == @current_page
              %li.page-item.active
                %span.page-link= page_num
            - else
              %li.page-item
                = link_to page_num, browse_scans_toc_path(@toc, page: page_num), class: 'page-link'

          - if @current_page < @total_pages
            %li.page-item
              = link_to t('tocs.browse_scans.next'), browse_scans_toc_path(@toc, page: @current_page + 1), class: 'page-link'
          - else
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.next')

          - if @current_page < @total_pages
            %li.page-item
              = link_to t('tocs.browse_scans.last'), browse_scans_toc_path(@toc, page: @total_pages), class: 'page-link'
          - else
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.last')

  .row.mt-3
    .col-md-12
      = submit_tag t('tocs.browse_scans.save_button'), class: 'btn btn-primary'
      = link_to t('common.actions.cancel'), @toc, class: 'btn btn-default'

:css
  .scan-grid .card {
    min-height: 300px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid #dee2e6;
  }
  .scan-grid .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }
  .scan-grid .card.selected {
    border-color: #667eea;
    background-color: #f7fafc;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  .scan-grid .card.selected .card-img-top {
    border: 3px solid #667eea;
  }
  .scan-grid .card-img-top {
    height: 200px;
    object-fit: contain;
    background-color: #f8f9fa;
    border: 3px solid transparent;
    transition: border-color 0.2s;
  }
  .scan-page {
    margin-bottom: 1rem;
  }

:javascript
  // Make scan cards clickable
  document.querySelectorAll('.scan-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
      // Don't toggle if clicking on links or checkbox/label
      if (e.target.tagName === 'A' || e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') {
        return;
      }

      const checkbox = this.querySelector('.page-checkbox');
      if (checkbox && !checkbox.disabled) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));

        // Toggle selected class
        if (checkbox.checked) {
          this.classList.add('selected');
        } else {
          this.classList.remove('selected');
        }
      }
    });
  });

  // Update card visual state when checkbox changes
  document.querySelectorAll('.page-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const card = this.closest('.scan-card');
      if (this.checked) {
        card.classList.add('selected');
        document.getElementById('no_explicit_toc').checked = false;
      } else {
        card.classList.remove('selected');
      }
    });
  });

  // Disable all checkboxes when "no explicit TOC" is checked
  document.getElementById('no_explicit_toc').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.page-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.disabled = this.checked;
      if (this.checked) {
        checkbox.checked = false;
        checkbox.closest('.scan-card').classList.remove('selected');
      }
    }.bind(this));
  });

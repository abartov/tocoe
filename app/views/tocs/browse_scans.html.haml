%h1= t('tocs.browse_scans.title', book_title: @toc.title)

%p
  = t('tocs.browse_scans.viewing_pages')
  = (@current_page - 1) * @page_size + 1
  = t('tocs.browse_scans.to')
  = [@current_page * @page_size, @metadata[:imagecount]].min
  = t('tocs.browse_scans.of')
  = @metadata[:imagecount]

/ Sticky header for selected pages
#selection-header.sticky-selection-header{style: 'display: none;'}
  .container-fluid
    .row.align-items-center
      .col-md-8
        .selection-info
          %strong.selection-count
          %span.glyphicon.glyphicon-info-sign.ml-2{title: t('tocs.browse_scans.selected_header_tooltip'), 'data-toggle': 'tooltip'}
        .selected-thumbnails-container
      .col-md-4.text-right
        %button.btn.btn-sm.btn-link.clear-selection{type: 'button'}
          %span.glyphicon.glyphicon-remove
          = t('tocs.browse_scans.clear_selection')

= form_tag mark_pages_toc_path(@toc), method: :post, id: 'mark_pages_form' do
  .row
    .col-md-12
      .alert.alert-info
        %strong= t('tocs.browse_scans.instructions_title')
        = t('tocs.browse_scans.instructions_text')

  .row
    .col-md-12
      .form-check.mb-3
        = check_box_tag 'no_explicit_toc', '1', @toc.no_explicit_toc, class: 'form-check-input', id: 'no_explicit_toc'
        = label_tag 'no_explicit_toc', t('tocs.browse_scans.no_explicit_toc_label'), class: 'form-check-label'
        = help_tooltip t('tocs.browse_scans.no_explicit_toc_tooltip'), placement: 'right'

  .row.scan-grid
    - @pages.each do |page_data|
      .col-md-3.col-sm-4.col-xs-6.scan-page{ data: { page: page_data[:page_number] } }
        .card.mb-3.scan-card{ class: (@marked_pages.include?(page_data[:url]) ? 'selected' : '') }
          .image-loading-container{style: "height: 200px;"}
            = image_tag page_data[:thumb_url], class: 'card-img-top image-loader', alt: t('tocs.browse_scans.page_label', number: page_data[:page_number]), data: { full_url: page_data[:url], image_id: "browse-#{page_data[:page_number]}" }
          .card-body
            .form-check
              = check_box_tag "marked_pages[]", page_data[:url], @marked_pages.include?(page_data[:url]), class: 'form-check-input page-checkbox', id: "page_#{page_data[:page_number]}"
              = label_tag "page_#{page_data[:page_number]}", t('tocs.browse_scans.page_label', number: page_data[:page_number]), class: 'form-check-label'
            %button.btn.btn-sm.btn-link.view-preview{ type: 'button', data: { url: page_data[:url], page: page_data[:page_number] }, onclick: 'event.stopPropagation();' }
              %span.glyphicon.glyphicon-eye-open
              = t('tocs.browse_scans.quick_preview')
            %a.btn.btn-sm.btn-link.view-full-link{ href: page_data[:url], target: '_blank', onclick: 'event.stopPropagation();' }
              %span.glyphicon.glyphicon-new-window
              = t('tocs.browse_scans.view_full_size')

  .row
    .col-md-12
      %nav{ aria: { label: 'Page navigation' } }
        %ul.pagination
          - if @current_page > 1
            %li.page-item
              = link_to t('tocs.browse_scans.first'), browse_scans_toc_path(@toc, page: 1), class: 'page-link'
            %li.page-item
              = link_to t('tocs.browse_scans.previous'), browse_scans_toc_path(@toc, page: @current_page - 1), class: 'page-link'
          - else
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.first')
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.previous')

          - ([1, @current_page - 2].max..[[@current_page + 2, @total_pages].min].min).each do |page_num|
            - if page_num == @current_page
              %li.page-item.active
                %span.page-link= page_num
            - else
              %li.page-item
                = link_to page_num, browse_scans_toc_path(@toc, page: page_num), class: 'page-link'

          - if @current_page < @total_pages
            %li.page-item
              = link_to t('tocs.browse_scans.next'), browse_scans_toc_path(@toc, page: @current_page + 1), class: 'page-link'
          - else
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.next')

          - if @current_page < @total_pages
            %li.page-item
              = link_to t('tocs.browse_scans.last'), browse_scans_toc_path(@toc, page: @total_pages), class: 'page-link'
          - else
            %li.page-item.disabled
              %span.page-link= t('tocs.browse_scans.last')

  .row.mt-3
    .col-md-12
      = submit_tag t('tocs.browse_scans.save_button'), class: 'btn btn-primary'
      = link_to t('common.actions.cancel'), @toc, class: 'btn btn-default'

/ Lightbox Modal for Image Preview
#scan-lightbox.modal.fade{tabindex: '-1', role: 'dialog', 'aria-labelledby': 'lightbox-title', 'aria-hidden': 'true'}
  .modal-dialog.modal-lg{role: 'document', style: 'max-width: 90%; margin: 30px auto;'}
    .modal-content
      .modal-header
        %button.close{type: 'button', 'data-dismiss': 'modal', 'aria-label': 'Close'}
          %span{'aria-hidden': 'true'} &times;
        %h4#lightbox-title.modal-title= t('tocs.browse_scans.lightbox_title')
      .modal-body.text-center
        %img#lightbox-image{src: '', alt: '', style: 'max-width: 100%; max-height: 80vh; object-fit: contain;'}
      .modal-footer
        %a#lightbox-new-tab.btn.btn-default{href: '#', target: '_blank'}
          %span.glyphicon.glyphicon-new-window
          = t('tocs.browse_scans.open_in_new_tab')
        %button.btn.btn-primary{type: 'button', 'data-dismiss': 'modal'}= t('common.actions.cancel')

:css
  /* Scan grid styles */
  .scan-grid .card {
    min-height: 320px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid #dee2e6;
  }
  .scan-grid .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }
  .scan-grid .card.selected {
    border-color: #667eea;
    background-color: #f7fafc;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  .scan-grid .card.selected .image-loading-container {
    border: 3px solid #667eea;
  }
  .scan-grid .image-loading-container {
    border: 3px solid transparent;
    transition: border-color 0.2s;
  }
  .scan-grid .card-img-top {
    height: 200px;
    object-fit: contain;
  }
  .scan-page {
    margin-bottom: 1rem;
  }

  /* Sticky selection header */
  .sticky-selection-header {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    margin-bottom: 20px;
    border-radius: 0 0 8px 8px;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .sticky-selection-header .selection-info {
    margin-bottom: 8px;
  }

  .sticky-selection-header .selection-count {
    font-size: 16px;
    margin-right: 8px;
  }

  .sticky-selection-header .glyphicon-info-sign {
    cursor: help;
    opacity: 0.8;
  }

  .sticky-selection-header .clear-selection {
    color: white;
    text-decoration: none;
    opacity: 0.9;
    transition: opacity 0.2s;
  }

  .sticky-selection-header .clear-selection:hover {
    opacity: 1;
    text-decoration: underline;
  }

  .selected-thumbnails-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .selected-thumbnail {
    position: relative;
    width: 45px;
    height: 60px;
    border: 2px solid white;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
  }

  .selected-thumbnail:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    z-index: 10;
  }

  .selected-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .selected-thumbnail .page-number-badge {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 9px;
    padding: 1px 3px;
    border-radius: 2px;
    font-weight: bold;
  }

  .selected-thumbnail .remove-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .selected-thumbnail:hover .remove-badge {
    opacity: 1;
  }

:javascript
  // Initialize Bootstrap tooltips
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });

  // I18n strings for JavaScript
  const i18nStrings = {
    selectedPageSingular: "#{I18n.t('tocs.browse_scans.selected_pages_text.one').html_safe}",
    selectedPagePlural: "#{I18n.t('tocs.browse_scans.selected_pages_text.other').html_safe}"
  };

  // Sticky header for selected pages
  var selectedPages = new Map(); // Map of checkbox value (URL) -> {pageNumber, url, thumbUrl}

  function updateSelectionHeader() {
    const header = document.getElementById('selection-header');
    const count = selectedPages.size;

    if (count === 0) {
      header.style.display = 'none';
      return;
    }

    // Show header
    header.style.display = 'block';

    // Update count with I18n pluralization
    const countText = count === 1 ? '1 ' + i18nStrings.selectedPageSingular : count + ' ' + i18nStrings.selectedPagePlural;
    header.querySelector('.selection-count').textContent = countText;

    // Update thumbnails
    const container = header.querySelector('.selected-thumbnails-container');
    container.innerHTML = '';

    // Sort by page number for consistent display
    const sortedPages = Array.from(selectedPages.entries()).sort((a, b) => {
      return parseInt(a[1].pageNumber) - parseInt(b[1].pageNumber);
    });

    sortedPages.forEach(function([url, data]) {
      const thumb = document.createElement('div');
      thumb.className = 'selected-thumbnail';
      thumb.setAttribute('data-page', data.pageNumber);
      thumb.setAttribute('data-url', url);
      thumb.title = 'Page ' + data.pageNumber + ' - Click to jump or deselect';

      thumb.innerHTML = '<img src="' + data.thumbUrl + '" alt="Page ' + data.pageNumber + '">' +
                        '<span class="page-number-badge">' + data.pageNumber + '</span>' +
                        '<span class="remove-badge">&times;</span>';

      thumb.addEventListener('click', function() {
        const pageNumber = this.getAttribute('data-page');
        const checkbox = document.getElementById('page_' + pageNumber);

        if (checkbox) {
          // Try to scroll to the page first
          const scanCard = checkbox.closest('.scan-page');
          if (scanCard) {
            scanCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Flash the card to indicate it
            const card = scanCard.querySelector('.scan-card');
            card.style.transition = 'all 0.3s ease';
            card.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.6)';
            setTimeout(function() {
              card.style.boxShadow = '';
            }, 1000);
          }

          // Deselect if clicked on remove badge or if shift key is held
          if (event.target.classList.contains('remove-badge') || event.shiftKey) {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
          }
        }
      });

      container.appendChild(thumb);
    });
  }

  function initializeSelectedPages() {
    // Populate selectedPages map from currently checked checkboxes
    document.querySelectorAll('.page-checkbox:checked').forEach(function(checkbox) {
      const scanPage = checkbox.closest('.scan-page');
      const pageNumber = scanPage.getAttribute('data-page');
      const img = scanPage.querySelector('.card-img-top');

      selectedPages.set(checkbox.value, {
        pageNumber: pageNumber,
        url: checkbox.value,
        thumbUrl: img.src
      });
    });

    updateSelectionHeader();
  }

  // Clear all selections
  document.querySelector('.clear-selection').addEventListener('click', function() {
    document.querySelectorAll('.page-checkbox:checked').forEach(function(checkbox) {
      checkbox.checked = false;
      checkbox.dispatchEvent(new Event('change'));
    });
  });

  // Lightbox functionality
  document.querySelectorAll('.view-preview').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const imageUrl = this.getAttribute('data-url');
      const pageNumber = this.getAttribute('data-page');

      // Update modal content
      document.getElementById('lightbox-image').src = imageUrl;
      document.getElementById('lightbox-image').alt = 'Page ' + pageNumber;
      document.getElementById('lightbox-title').textContent = 'Page ' + pageNumber + ' Preview';
      document.getElementById('lightbox-new-tab').href = imageUrl;

      // Show the modal
      $('#scan-lightbox').modal('show');
    });
  });

  // Also allow clicking on thumbnail images for preview
  document.querySelectorAll('.card-img-top').forEach(function(img) {
    img.style.cursor = 'zoom-in';
    img.addEventListener('click', function(e) {
      e.stopPropagation();

      const imageUrl = this.getAttribute('data-full-url');
      const imageId = this.getAttribute('data-image-id');
      const pageNumber = imageId.replace('browse-', '');

      // Update modal content
      document.getElementById('lightbox-image').src = imageUrl;
      document.getElementById('lightbox-image').alt = 'Page ' + pageNumber;
      document.getElementById('lightbox-title').textContent = 'Page ' + pageNumber + ' Preview';
      document.getElementById('lightbox-new-tab').href = imageUrl;

      // Show the modal
      $('#scan-lightbox').modal('show');
    });
  });

  // Make scan cards clickable
  document.querySelectorAll('.scan-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
      // Don't toggle if clicking on links, buttons, checkbox/label, or images
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL' || e.target.tagName === 'IMG' || e.target.classList.contains('glyphicon')) {
        return;
      }

      const checkbox = this.querySelector('.page-checkbox');
      if (checkbox && !checkbox.disabled) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));

        // Toggle selected class
        if (checkbox.checked) {
          this.classList.add('selected');
        } else {
          this.classList.remove('selected');
        }
      }
    });
  });

  // Update card visual state when checkbox changes
  document.querySelectorAll('.page-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const card = this.closest('.scan-card');
      const scanPage = this.closest('.scan-page');
      const pageNumber = scanPage.getAttribute('data-page');
      const img = scanPage.querySelector('.card-img-top');

      if (this.checked) {
        card.classList.add('selected');
        document.getElementById('no_explicit_toc').checked = false;

        // Add to selectedPages map
        selectedPages.set(this.value, {
          pageNumber: pageNumber,
          url: this.value,
          thumbUrl: img.src
        });
      } else {
        card.classList.remove('selected');

        // Remove from selectedPages map
        selectedPages.delete(this.value);
      }

      // Update sticky header
      updateSelectionHeader();
    });
  });

  // Disable all checkboxes when "no explicit TOC" is checked
  document.getElementById('no_explicit_toc').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.page-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.disabled = this.checked;
      if (this.checked) {
        checkbox.checked = false;
        checkbox.closest('.scan-card').classList.remove('selected');
      }
    }.bind(this));

    // Clear selectedPages map and update header
    if (this.checked) {
      selectedPages.clear();
      updateSelectionHeader();
    }
  });

  // Initialize sticky header on page load
  initializeSelectedPages();

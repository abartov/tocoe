-# Review Authors Page
-# Shows all work-author pairs for manual person matching

.container.mt-4
  .row
    .col-md-12
      %h1= t('tocs.review_authors.title', toc_title: @toc.title)

      %p.lead= t('tocs.review_authors.instructions')

      -# Show progress
      .alert.alert-info
        = t('tocs.review_authors.progress_message', total: @work_author_pairs.length)

      -# List all work-author pairs
      .work-author-pairs
        - @work_author_pairs.each_with_index do |pair, index|
          - work = pair[:work]
          - authors = pair[:authors]
          - title = pair[:title]

          .card.mb-3{id: "work-#{work.id}"}
            .card-header
              %h5.mb-0
                = "#{index + 1}. #{title}"

            .card-body
              - if authors.any?
                -# Work has explicit authors in TOC
                %p.mb-2
                  %strong= t('tocs.review_authors.authors_to_match')
                %ul.list-unstyled
                  - authors.each do |author_data|
                    - author_name = author_data[:name]
                    - role = author_data[:role]
                    - role_label = role == :translator ? t('tocs.review_authors.role_translator') : t('tocs.review_authors.role_author')

                    %li.mb-3.d-flex.justify-content-between.align-items-center{id: "work-#{work.id}-author-#{author_name.parameterize}"}
                      .author-info
                        %span.author-name
                          = author_name
                        %span.badge.badge-secondary.ml-2
                          = role_label

                      .match-actions
                        -# Check if already matched
                        - if role == :translator
                          - existing_match = work.expressions.first&.realizers&.find_by(name: author_name)
                        - else
                          - existing_match = work.creators.find_by(name: author_name)

                        - if existing_match
                          %span.badge.badge-success
                            = t('tocs.review_authors.matched')
                            = existing_match.name
                        - else
                          %button.btn.btn-primary.btn-sm.match-button{
                            type: 'button',
                            data: {
                              work_id: work.id,
                              author_name: author_name,
                              role: role,
                              target_type: role == :translator ? 'Expression' : 'Work',
                              target_id: role == :translator ? work.expressions.first&.id : work.id
                            }
                          }
                            = t('tocs.review_authors.match_button')

              - else
                -# Work has no explicit authors - inherit from TOC
                %p.text-muted
                  = t('tocs.review_authors.no_explicit_authors')
                - if @toc_authors.any?
                  %p.mb-2
                    %strong= t('tocs.review_authors.inherited_authors_from_toc')
                  %ul.list-unstyled
                    - @toc_authors.each do |toc_author|
                      %li.mb-3.d-flex.justify-content-between.align-items-center
                        .author-info
                          %span.author-name
                            = toc_author.name
                          %span.badge.badge-secondary.ml-2
                            = t('tocs.review_authors.role_author')

                        .match-actions
                          - existing_match = work.creators.find_by(id: toc_author.id)
                          - if existing_match
                            %span.badge.badge-success
                              = t('tocs.review_authors.matched')
                              = existing_match.name
                          - else
                            %button.btn.btn-success.btn-sm.accept-parent-match-button{
                              type: 'button',
                              data: {
                                work_id: work.id,
                                person_id: toc_author.id,
                                person_name: toc_author.name,
                                role: 'author'
                              }
                            }
                              = t('tocs.review_authors.accept_parent_match_button')
                            %button.btn.btn-outline-secondary.btn-sm.match-button.ml-2{
                              type: 'button',
                              data: {
                                work_id: work.id,
                                author_name: toc_author.name,
                                role: 'author',
                                target_type: 'Work',
                                target_id: work.id
                              }
                            }
                              = t('tocs.review_authors.match_different_person')

      -# Footer actions
      .mt-4.d-flex.justify-content-between
        = link_to t('common.actions.back'), @toc, class: 'btn btn-secondary'
        = link_to t('tocs.review_authors.skip_for_now'), @toc, class: 'btn btn-outline-secondary'

-# Include person matcher modal
= render 'shared/person_matcher'

:javascript
  $(document).ready(function() {
    // Handle match button clicks (opens person matcher)
    $('.match-button').on('click', function() {
      var $button = $(this);
      var authorName = $button.data('author-name');
      var role = $button.data('role');
      var targetType = $button.data('target-type');
      var targetId = $button.data('target-id');

      // Open person matcher modal
      PersonMatcher.open(targetType, targetId, authorName, []);

      // Note: After successful match, the person matcher will reload the page
      // to show the updated "matched" status
    });

    // Handle accept parent match button clicks (direct association)
    $('.accept-parent-match-button').on('click', function() {
      var $button = $(this);
      var workId = $button.data('work-id');
      var personId = $button.data('person-id');
      var personName = $button.data('person-name');
      var role = $button.data('role');

      // Confirm with user
      if (!confirm('Accept "' + personName + '" as author for this work?')) {
        return;
      }

      // Disable button during request
      $button.prop('disabled', true).text('Accepting...');

      // Make AJAX request to accept parent match
      $.ajax({
        url: '/people/accept_parent_match',
        type: 'POST',
        dataType: 'json',
        data: {
          work_id: workId,
          person_id: personId,
          role: role
        },
        beforeSend: function(xhr) {
          xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
        },
        success: function(data) {
          if (data.success) {
            // Reload page to show updated status
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Failed to accept match'));
            $button.prop('disabled', false).text('Accept Match from Parent');
          }
        },
        error: function() {
          alert('Error: Failed to accept match. Please try again.');
          $button.prop('disabled', false).text('Accept Match from Parent');
        }
      });
    });
  });

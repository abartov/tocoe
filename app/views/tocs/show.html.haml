= render 'shared/workflow_stepper', toc: @toc

%p#notice= notice

.toc-header{style: 'margin-bottom: 1.5rem;'}
  %h2{style: 'font-size: 1.8rem; color: #2d3748; margin-bottom: 0.5rem;'}= @toc.title
  %p{style: 'color: #4a5568;'}
    %strong= t('tocs.show.book_uri_label', default: 'Book URI:')
    = @toc.book_uri
  %p
    %span.status-badge{class: "status-#{@toc.status}", style: 'display: inline-block; padding: 0.35rem 0.85rem; border-radius: 16px; font-size: 0.85rem; font-weight: 600;'}
      = status_badge_with_icon(@toc.status)

.mb-3
  = link_to t('common.actions.edit'), edit_toc_path(@toc), class: 'btn btn-primary'
  = link_to t('common.actions.back'), tocs_path, class: 'btn btn-secondary'
  - unless @toc.no_explicit_toc || @is_gutenberg
    = link_to t('tocs.show.browse_scans_link'), browse_scans_toc_path(@toc), class: 'btn btn-info'

- if @toc.pages_marked?
  .alert.alert-info.status-alert{style: 'border-left: 4px solid #3182ce; background: #ebf8ff; border-radius: 8px; padding: 1.5rem;'}
    .d-flex.align-items-start
      %span{style: 'font-size: 2rem; margin-right: 1rem;'} üìë
      .flex-grow-1
        %p{style: 'margin-bottom: 0.75rem;'}
          %strong{style: 'font-size: 1.1rem; color: #2c5282;'}= t('tocs.show.pages_marked_alert.title')
        %p{style: 'color: #2d3748; margin-bottom: 1rem;'}= t('tocs.show.pages_marked_alert.description')
        %p{style: 'margin: 0;'}
          = link_to t('tocs.show.pages_marked_alert.edit_button'), edit_toc_path(@toc), class: 'btn btn-primary'
          = button_to t('tocs.show.pages_marked_alert.mark_transcribed_button'), mark_transcribed_toc_path(@toc), method: :post, class: 'btn btn-success', data: { confirm: t('tocs.show.pages_marked_alert.confirm_transcribed') }

- elsif @toc.transcribed?
  .alert.alert-success.status-alert{style: 'border-left: 4px solid #38a169; background: #f0fff4; border-radius: 8px; padding: 1.5rem;'}
    .d-flex.align-items-start
      %span{style: 'font-size: 2rem; margin-right: 1rem;'} üìÑ
      .flex-grow-1
        %p{style: 'margin-bottom: 0.75rem;'}
          %strong{style: 'font-size: 1.1rem; color: #22543d;'}= t('tocs.show.transcribed_alert.title')
        %p{style: 'color: #2d3748; margin-bottom: 1rem;'}= t('tocs.show.transcribed_alert.description')
        - if current_user && @toc.contributor_id == current_user.id
          %p.text-warning{style: 'margin-bottom: 1rem;'}
            ‚ö†Ô∏è
            = t('tocs.show.transcribed_alert.cannot_verify_own')
        - else
          %p{style: 'margin: 0;'}
            = button_to t('tocs.show.transcribed_alert.verify_button'), verify_toc_path(@toc), method: :post, class: 'btn btn-success', data: { confirm: t('tocs.show.transcribed_alert.confirm_verified') }

- if @toc.no_explicit_toc
  %p
    %b= t('tocs.show.no_explicit_toc')
- elsif @toc.empty?
  .alert.alert-warning.status-alert{style: 'border-left: 4px solid #d69e2e; background: #fefcbf; border-radius: 8px; padding: 1.5rem;'}
    .d-flex.align-items-start
      %span{style: 'font-size: 2rem; margin-right: 1rem;'} üìù
      .flex-grow-1
        %p{style: 'margin-bottom: 0.75rem;'}
          %strong{style: 'font-size: 1.1rem; color: #744210;'}= t('tocs.show.empty_alert.title')
        %p{style: 'color: #2d3748; margin: 0;'}= t('tocs.show.empty_alert.description')

.row
  - if @is_gutenberg && @fulltext_url.present?
    .col-md-6
      - if @toc.toc_body.present?
        %p
          %b= t('tocs.show.toc_body')
        .toc-preview
          = toc_markdown_to_html_preview(@toc.toc_body)
      - else
        %h3.text-muted= t('tocs.show.no_toc_body')
    .col-md-6
      %p
        %b= t('tocs.show.fulltext')
      .fulltext-viewer
        %iframe{src: @fulltext_url, style: 'width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 4px;'}
  - else
    .col-md-8
      - if @toc.toc_body.present?
        %p
          %b= t('tocs.show.toc_body')
        .toc-preview
          = toc_markdown_to_html_preview(@toc.toc_body)

    - if @toc.toc_page_urls.present?
      .col-md-4
        %p
          %b= t('tocs.show.marked_toc_pages')
          = "(#{@toc.toc_page_urls.split("\n").count})"
        .toc-page-thumbnails
          - @toc.toc_page_urls.split("\n").each_with_index do |url, index|
            .toc-page-thumb.mb-2
              = link_to url, target: '_blank' do
                = image_tag "#{url}?scale=8", alt: t('tocs.show.page_number', number: index + 1), class: 'img-thumbnail'
              .text-center.small
                = t('tocs.show.page_number', number: index + 1)
- if current_user&.admin?
  %p
    %b= t('common.labels.contributor')
    = @toc.contributor&.name || @toc.contributor_id
  %p
    %b= t('common.labels.reviewer')
    = @toc.reviewer&.name || @toc.reviewer_id
%p
  %b= t('common.labels.comments')
  = @toc.comments
%hr
- if @manifestation
  = render partial: 'manifestations/show', locals: { manifestation: @manifestation }

:css
  .toc-page-thumbnails {
    max-height: 600px;
    overflow-y: auto;
  }
  .toc-page-thumb img {
    max-width: 100%;
    height: auto;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .toc-page-thumb img:hover {
    transform: scale(1.05);
  }
  .toc-page-thumb {
    border: 1px solid #dee2e6;
    padding: 8px;
    border-radius: 4px;
    background-color: #f8f9fa;
  }
  .toc-preview {
    border: 1px solid #dee2e6;
    padding: 15px;
    border-radius: 4px;
    background-color: #fff;
  }
  .toc-preview h1 {
    font-size: 1.5em;
    margin: 10px 0;
    font-weight: bold;
  }
  .toc-preview h2 {
    font-size: 1.2em;
    margin: 8px 0 8px 20px;
    font-weight: normal;
  }
  .toc-preview .toc-section {
    color: #6c757d;
    font-style: italic;
  }
  .toc-preview .toc-author {
    color: #6c757d;
    font-size: 0.9em;
    font-weight: normal;
    margin-left: 10px;
  }
  .toc-preview .toc-author:before {
    content: "‚Äî ";
  }
